name: Deploy docs to latest GitHub Pages

# Run this workflow when the "Deploy docs to versioned GitHub Pages" workflow completes
on:
  workflow_run:
    workflows: ["Deploy docs to versioned GitHub Pages"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy-latest:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history for tags

      - name: Get latest tag and verify for push events
        run: |
          # Get all tags, sort them semantically, and pick the highest stable version
          LATEST_TAG=$(git tag --sort=-v:refname | grep -v - | head -n 1)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

          if [ "${{ github.event_name }}" == "push" ]; then
            TRIGGER_TAG=${{ github.ref_name }}
            if [ "$TRIGGER_TAG" != "$LATEST_TAG" ]; then
              echo "The triggered tag ($TRIGGER_TAG) is not the latest tag ($LATEST_TAG). Not deploying to 'latest'."
              exit 1
            fi
          fi

      - name: Checkout latest tag
        uses: actions/checkout@v6
        with:
          ref: ${{ env.LATEST_TAG }}

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build
        working-directory: docs
        env:
          BASE_PATH: "/${{ github.event.repository.name }}"
        run: pnpm run build

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/build/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
